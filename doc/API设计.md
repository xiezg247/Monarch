

# 接口规范文档

- [一 基本原则](#一-基本原则)
- [二 字典共识](#二-字典共识)
- [三 接口设计规范](#三-接口设计规范)
  - [字段命名](#字段命名)
  - [Content-Type](#content-type)
  - [响应格式](#响应格式)
  - [分页](#分页)
  - [基于时间/游标的分页](#基于时间游标的分页)
  - [基于时间/游标的分页 + 增量更新](#基于时间游标的分页--增量更新)
- [三 接口设计规范/实例](#三-接口设计规范实例)
  - [单个对象](#单个对象)
  - [多个对象](#多个对象)
  - [对象列表](#对象列表)
- [四 错误码前缀](#四-错误码前缀)

## 一 基本原则

1. 尽可能减少不必要的沟通

   开发中，最大的成本在于沟通，在决定方案的时候，是一个必须考虑的问题。原则 2.3.5.6都是可以减少不必要的沟通。

2. 见其名，知其意

   后期维护成本，是占开发周期中很大一部分。若不能见名知意，后期自己维护都非常困难，如果是别人，就更苦逼了，并且会导致前后端的沟通（违背原则1）

3. 原则不要用缩写，除非团队内达成共识的

   不同人有不同的缩写习惯，如使用没有达成一致的缩写，会导致潜在bug，增加沟通成本（违背原则1）

4. 命名规则

   URL路径采用驼峰或者下划线，由前后端共同商议，不强制要求。
   request && response请求参数以及返回结果字段：下划线

5. 数据啥类型，就返回啥类型

   - int/long 返回 int/long
   - String 返回 String
   - float/double 返回 int（通过调整单位实现）。如：`12.13` 元，转化成 `1213` 分，端与端间传递 `1213` int
   - 同一类型的数据必须单位一样。如，所有关于 钱的数据，单位必须为 分; 所有关于重量的单位必须是 克。**以最小单位表示数据，避免出现小数的情况**
   - 时间数据采用时间戳形式返回，数据类型： `long`， 单位： `ms`
   - 布尔值：`true` / `false`

6. 对象意识

   一般一个接口建议只返回一个对象数据，视业务场景需要。返回多个对象应慎重，需要考虑服务器性能，
   接口逻辑是否有必要的耦合等因素

7. msg控制前端提示消息

   可连接服务器的情况下，前端不处理任何提示消息。不管成功还是失败的消息，提示消息均由后端返回。有消息则提示，无消息则不提示  
   未能连接服务器时，本地处理提示消息。主要场景（不限于）：本地网络异常、服务器不可达 等等。。。

8. 同一意思，同一单词

   如: 常用来表达性别的单词有：sex，gender，端与端间表示性别的单词只能而选一，如只能出现 `gender`

9. 区分代理服务器(nginx)与业务服务器(program)返回的结果

   业务服务器会在请求响应(response)的header打上特定的标签(tag)，以区分该请求是通过业务服务器返回，还是直接由代理服务(nginx)器返回。

10. Python: HTTP状态码(http status)与业务响应代码(code)

    业务服务器返回的HTTP状态码遵循restful风格，如实返回HTTP请求的结果，如成功处理是200，资源没找到是404，服务器错误是500。  
    业务响应代码是HTTP状态码的超集，包含业务系统自定义的状态码，除去自定义的状态码，HTTP状态码与业务响应代码等价。

    ```
    """
    正常http状态码 200 302 400 401 403 404 500
    
    1. 当http请求失败，返回失败的http状态码
    2. 当http请求验证数据失败，返回http状态码400
    3. 当http请求成功，业务处理失败，返回http状态码200
    
    当http状态码是302/400/401/403/404/500 前端这边直接处理了http请求 不往下走业务逻辑
    当http状态码是200 业务状态码是自定义时 前端先处理http请求 然后处理业务逻辑 比如说表单提交 参数错误时 返回400业务状态码 前端会根据返回的错误处理逻辑 给予提示
       - 因此http状态码是200 仅仅代表网络请求正常 具体业务处理还需要根据数据包的code来判断
       - http code 200 返回数据：
            {'code': 200, msg: '操作成功', 'data': {} }
       - http code 200 返回数据：
            {
                "code": 400001,
                "msg": "参数错误",
                "data": {
                    "status": [
                        "Missing data for required field."
                    ],
                    "department_id": [
                        "Missing data for required field."
                    ],
                    "name": [
                        "Not a valid string."
                    ],
                    "type": [
                        "Missing data for required field."
                    ]
                }
            }
    """
    ```

## 二 字典共识

此处维护行业共识和团队内共识的字典，主要包括：缩写、特殊单词等

- internationalization - i18n

**原则上不使用缩写，可读性优先**

## 三 接口设计规范

### 字段命名

字段使用「小写 + 下划线」的方式进行命名。

例如，公司编码应该被命名为：`company_code`，不应该被命名为 `companyCode`。

### Content-Type

除非特别说明，请求和响应应该使用 [JSON](http://json.org) 对请求和响应进行编码。在使用 JSON 编码时，请求和响应都应该设置 `Content-Type: application/json` 头。

### 响应格式

- Python: 响应应当正确使用 HTTP status

  例如，参数错误应返回 400，请求的资源不存在应返回 404，请求超过频率限制应返回 429。

- code 说明

  Python: 200 表示成功，不要出现 0 表示不成功的情况; 

- 成功时， 统一采用如下的响应格式：

  ```js
  {
      "code": ***, 
      "data": xxxxx, // data 始终是个对象
      "msg": ""  // 返回人类可读的消息，请求失败的时候返回错误信息。
  }
  ```

- 出错时， `message` 字段用于传输可读的错误信息：

  ```js
  {
      "code": 255,
      // 仍然返回 data 字段
      "data": {},
      "msg": "id 不是数字"
  }
  ```

- 返回中的 `data` 应该始终为一个 `object`，对于 `result` 中的值，建议使用有意义的名词作为 key，例如：

  ```js
  {
      "code": 200,
      "data": {
          "users": ["<User>"]
      },
      "msg": ""
  }
  ```

- 获取资源：`GET` 请求

- 对于创建,更新,删除对象的请求：`POST` / `PUT` / `DELETE` ，响应应该完整包含被修改后的对象。
  例如

  `POST /fd/api/user/v1/users`

  ```js
  {
      "code": 200,
      // 仍然返回 data
      "data": {
        "user" : '<User>'
      },
      "msg": ""
  }
  ```

### 分页

分页使用 `page` 和 `per_page` 参数来进行分页，例如：

`GET /api/user/v1/users/fuzzy?mobile=134&page=1&per_page=100`

`page` 从 1 开始，默认值为 1。

`per_page` 默认值依接口而定，推荐 20，`per_page` 最大不超过 1000，超过 1000
按 1000 处理。

分页的响应格式：

```js
{
    "page" : 1,   // 当前页
    "per_page" : 20，    // 每页包含多少条记录
    "total_pages" : 1000, // 总页数
    "total_count": 12345 // 总记录条数
}
```

分页的内容都会放在 `data` 中，也就是说，如果请求 `GET /fd/api/user/v1/users/fuzzy?mobile=134&page=1&per_page=100`，响应应该是：

```js
{
    "code": 0,
    "data": {
        "users": ["<User>"],
        "pagination": {
            "page": 1,
            "per_page": 100,
            "total_pages": 50，
            "total_count": 12345
        }
    },
    "msg": ""
}
```

下面将 `pagination` 中的对象简记为 `<Pagination>`。

## 三 接口设计规范/实例

### 单个对象

```js
{
    "code": 200,
    "msg": "Hello World",
    "data": {
        "user": {
            "id": 1,
            "time": 1495728000000,
            "money": 1234,
            "name": "zhuzher",
            "company": "vanke service",
            "phone_list": [
                "17817189141",
                "17817189142",
                "17817189143"
            ]
        }
    }
}

```

### 多个对象

```js
{
    "code": 200,
    "msg": "Hello World",
    "data": {
        "user": {
            "id": 1,
            "time": 1495728000000,
            "money": 1234,
            "name": "zhuzher",
            "company": "vanke service",
            "phone_list": [
                "17817189141",
                "17817189142",
                "17817189143"
            ]
        },
        "main_house": {
            "code": "abc123475",
            "name": "houseName",
            "project_code": "abc123456",
            "project_name": "projectName"
        }
    }
}

```

### 对象列表

```js
{
    "code": 200,
    "msg": "Hello World",
    "data": {
        "users": [
            {
                "id": 1,
                "time": 1495728000000,
                "money": 1234,
                "name": "zhuzher",
                "company": "vanke service",
                "phone_list": [
                    "17817189141",
                    "17817189142",
                    "17817189143"
                ]
            },
            {
                "id": 2,
                "time": 1495728000000,
                "money": 1235,
                "name": "zhuzher2",
                "company": "vanke service3",
                "phone_list": [
                    "17817189141",
                ]
            },
        ],
        "pagination": {
        }
    }
}

```

## 四 错误码前缀

下面是内部的错误码前缀定义，错误码应该都是如下格式：`$PREFIX$CODE`，其中 `$PREFIX` 是下表中定义的各系统的前缀，`$CODE` 是业务内实际的错误码。

| 业务系统              | 自定义错误编码前缀 |      |      |      |      |
| --------------------- | ------------------ | ---- | ---- | ---- | ---- |
| 网关服务(Api Gateway) | 100                |      |      |      |      |
| 用户中心(User Center) | 200                |      |      |      |      |
|                       |                    |      |      |      |      |